<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>私人遊樂場地契約用地地圖</title>
    <meta name="author" content="香港01">
    <meta name="description" content="車主福音！一圖睇清全港各區泊車位！香港開放數據落後，我地為你搜集咗全港停車場位置，除咗室內停車場，仲有露天停車場同咪錶位！">
    <meta name="publisher" content="HK01">

    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
        crossorigin="" />
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js" integrity="sha512-tAGcCfR4Sc5ZP5ZoVz0quoZDYX5aCtEm/eu1KhSLj2c9eFrylXZknQYmxUssFaVJKvvc0dJQixhGjG2yXWiV9Q=="
        crossorigin=""></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU"
        crossorigin="anonymous">


    <link rel="stylesheet" href="src/custom.css">
    <script src="src/playgrounds.js"></script>
    <script src="src/pgContents.js"></script>
    <script src="src/siema.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/flickity@2/dist/flickity.min.css">
    <script src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script>



</head>

<body>

    <div id='mapid'></div>
    <div class="card card--mobile card--hidden">
        <div class="card-header">
            <span id="cardType"></span>
            <button type="button" class="close" id="close-card" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <button type="button" class="close" id="nextBtn" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">＞</span>
            </button>
            <button type="button" class="close" id="prevBtn" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">＜</span>
            </button>
        </div>
        <div class="card-body">
            <span class="card-title" id="cardName"></span>
            <div id="siema_container">
                <div class="siema_control">
                    <button id="prev" class="btn btn-light btn-sm">&#9668;</button>
                    <button id="next" class="btn btn-light btn-sm">&#9658;</button>
                </div>
                <div class="siema"></div>
            </div>
                <p class="caption"></p>&nbsp;<span class="credit"></span>
            
            <div class="container">
                <ul class="fa-ul" id="cardDetail"></ul>
                <p class="remarks"></p>
            </div>
            <div id="infogram"> </div>
        </div>
        <div class="card-footer hide"><a id="article" href="" target="_blank">前往文章 ⟶</a></div>
    </div>


    <script>
        var layers = {};
        var pgmap;
        var entrySource;
        var initialID = 0;
        var currentID = -1;
        var lastClickedLayerID = -1;
        var playground_layer;

        var mySiema;

        var shape_blue = {
            'color': '#0017c7',
            'weight': 2,
            'fillColor': '#0017c7',
            'fillOpacity': 0.5
        };

        var shape_red = {
            'color': '#F21326',
            'weight': 2,
            'fillColor': '#F21326',
            'fillOpacity': 0.5
        };

        function detectSource(callback) {
            let linkText = window.location.href;
            entrySource = (linkText.match(/#/)) ? linkText.match(/#(.*?)(&|$)/)[1] : "organic";
            initialID = (linkText.match(/&id=/)) ? parseInt(linkText.match(/&id=(\d+)/)[1]) : 0;
            var entryPoint = "";


            switch (entrySource) {
                case "article":
                    var prevent_double_count = 1;
                    entryPoint = "other_article";
                    // m6map.once('movestart', function () {
                    //     fireArticlePV(removehash(window.location.href));
                    // })
                    break;
                case "self":
                    entryPoint = "base_article";
                    break;
                case "issue":
                    entryPoint = "issue";
                    // fireArticlePV(removehash(window.location.href));
                    break;
                case "freeze":
                    entryPoint = "freeze";
                    break
                default:
                    // window.location.href = "https://www.hk01.com";
                    entryPoint = "organic";
                // fireArticlePV(removehash(window.location.href));
            }
            callback(entryPoint, initialID);
        }


        detectSource(initMap);

        function initMap(entryPoint, initialID) {
            console.log(entryPoint + " | initialID: " + initialID);
            var map_options = {
                center: (screen.width >= 768) ? [22.372809, 114.120322] : [22.372809, 114.1660907],
                zoom: 11, //(screen.width >= 768) ? 11 : 11,
                zoomSnap: 0,
                zoomDelta: 1,
                wheelPxPerZoomLevel: 40,
                maxBounds: ([
                    [21.795661, 113.073929],
                    [23.113786, 115.230749]
                ]),
                keyboard: false // Prevent jumping in iframe
            }

            pgmap = L.map('mapid', map_options);

            L.tileLayer('https://maptile.hk01.com/tile/{z}/{x}/{y}.png', {
                maxZoom: 18,
                minZoom: 10,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(pgmap);

            playground_layer = L.geoJSON(playgrounds, {
                onEachFeature: loopLayer,
                style: shape_blue,
            }).addTo(pgmap);

            var overlayMaps = {
                "用地": playground_layer
            };
        }



        var card = document.querySelector('.card--mobile');
        var card_header = document.querySelector('.card-header');
        var card_title = document.querySelector('.card-title');

        card_header.addEventListener('click', (event) => {
            card.classList.toggle('card--expanded');
            event.stopPropagation();
        });

        card_title.addEventListener('click', (event) => {
            card.classList.toggle('card--expanded');
            event.stopPropagation();
        });

        var closeCard = document.querySelector('#close-card');
        closeCard.addEventListener('click', (event) => {
            card.classList.add("card--hidden");
            card.classList.remove('card--expanded');

            document.querySelector('.card-footer').classList.add("hide");
            document.querySelector('.card-footer').classList.remove("show");

            destroySiema();
            lastClickedLayerID = currentID;
            resetStyle(currentID);
            currentID = 0;
            console.log("lastClickedLayerID: " + lastClickedLayerID + " | currentID: " + currentID);

            event.stopPropagation();
        });

        document.getElementById('nextBtn').addEventListener('click', function (event) {
            event.preventDefault();
            lastClickedLayerID = currentID;
            destroySiema();
            if (currentID < 27) popByID(currentID + 1);
            else popByID(1);

            event.stopPropagation();
        })

        document.getElementById('prevBtn').addEventListener('click', function (event) {
            event.preventDefault();
            lastClickedLayerID = currentID;
            destroySiema();
            if (currentID > 1) popByID(currentID - 1);
            else popByID(27);

            event.stopPropagation();
        })

        document.getElementById('prev').addEventListener('click', (e) => {
            mySiema.prev();
            e.stopPropagation();
        });

        document.getElementById('next').addEventListener('click', (e) => {
            mySiema.next();
            e.stopPropagation();
        });

        function loopLayer(feature, layer) {
            layers[feature.properties.id] = layer;
            var bbox;
            switch (parseInt(feature.properties.id)) {
                case 2:
                    bbox = L.latLngBounds([22.278790, 114.190460], [22.280482, 114.192329]);
                    break;
                case 10:
                    bbox = L.latLngBounds([22.273413, 114.180323], [22.275704, 114.183000]);
                    break;
                case 17:
                    bbox = L.latLngBounds([22.267781, 114.190859], [22.269909, 114.193376]);
                    break;
                default:
                    bbox = layer.getBounds();
            }
            var cal_box = bbox.extend([bbox.getSouth() - (bbox.getNorth() - bbox.getSouth()) * 2.5, bbox.getEast()]);
            layers[feature.properties.id].feature.properties.cal_bound = cal_box;

            layer.on('click', function (e) {
                popByClick(e);
            })
        }

        function popByClick(e) {
            if (parseInt(e.target.feature.properties.id) != currentID) {
                popByID(e.target.feature.properties.id);
            }
        }

        function popByID(id) {
            if (initialID != -1) lastClickedLayerID = currentID;
            currentID = parseInt(id);
            int_ID = parseInt(id);
            playgrounds.find(function (element) {
                if (parseInt(element.properties.id) == int_ID) {
                    switch (int_ID) {
                        case 2:
                            layers[2.1].setStyle(shape_red);
                            layers[2.2].setStyle(shape_red);
                            break;
                        case 10:
                            layers[10.1].setStyle(shape_red);
                            layers[10.2].setStyle(shape_red);
                            break;

                        case 17:
                            layers[17.1].setStyle(shape_red);
                            layers[17.2].setStyle(shape_red);
                            break;
                        default:
                            layers[int_ID].setStyle(shape_red);
                    }

                    resetStyle(lastClickedLayerID);
                    
                    createPopup(element);
                    zoomToPolygon(id);

                    var stateObj = { playground_id: currentID };
                    window.history.pushState(stateObj, "", `#${entrySource}&id=${currentID}`);
                    console.log("lastClickedLayerID: " + lastClickedLayerID + " | currentID: " + currentID);
                }
            });
        }

        function resetStyle(id) {
            if (lastClickedLayerID > 0) {
                switch (id) {
                    case 2:
                        playground_layer.resetStyle(layers[2.1]);
                        playground_layer.resetStyle(layers[2.2]);
                        break;
                    case 10:
                        playground_layer.resetStyle(layers[10.1]);
                        playground_layer.resetStyle(layers[10.2]);
                        break;
                    case 17:
                        playground_layer.resetStyle(layers[17.1]);
                        playground_layer.resetStyle(layers[17.2]);
                        break;
                    default:
                        playground_layer.resetStyle(layers[id]);
                }
            }
        }



        function zoomToPolygon(id) {
            var parseID;
            switch (id) {
                case 2:
                    parseID = 2.1;
                    break;
                case 10:
                    parseID = 10.1;
                    break;
                case 17:
                    parseID = 17.1;
                    break;
                default:
                    parseID = id;
            }
            console.log(parseID);
            pgmap.fitBounds(layers[parseID].feature.properties.cal_bound, { padding: [50, 50] });
        }

        function createPopup(element) {
            var prop = element.properties;

            document.getElementById("cardType").textContent = prop["type"];
            document.getElementById("cardType").className = (prop["type"] == "港島") ? "blue" : (prop["type"] == "九龍") ? "red" : "green";

            document.getElementById("cardName").innerHTML = prop["chi_name"];
            var content = `
                    <li><span class="fa-li"><i class="fas fa-expand-arrows-alt fa-fw"></i></span>面積：${(prop["area"] > 9999) ? numberWithCommas(Math.round(prop["area"] / 10000, 0)) + '公頃' : numberWithCommas(prop["area"]) + '呎'}</li>`

            content += `<li><span class="fa-li"><i class="fas fa-user-circle fa-fw"></i></span>會員：${numberWithCommas(prop["members"])}人</li>`;

            if (prop["avg_usage"]) content += `<li><span class="fa-li"><i class="fas fa-golf-ball fa-fw"></i></span>體育設施平均使用率：${prop["avg_usage"]}</li>`
            if (prop["comm_revenue"] > 0) content += `<li><span class="fa-li"><i class="fas fa-hand-holding-usd fa-fw"></i></span>最新年度的商業收入佔比：${prop["comm_revenue_percent"]}</li>`

                +
                `<li><span class="fa-li"><i class="fas fa-calendar-times fa-fw"></i></span>契約到期：${prop["due_date"]}</li>         
            `

            document.getElementById("cardDetail").innerHTML = content;
            document.querySelector(".remarks").innerHTML = prop["remarks"];
            document.getElementById("article").textContent = "會員人數有水份？前往文章 ⟶";
            document.getElementById("article").setAttribute("href", prop["article"]);
            // if (prop['infogram']) {
            //     document.getElementById("infogram").innerHTML = prop['infogram'];
            //     !function (e, t, n, s) { var i = "InfogramEmbeds", o = e.getElementsByTagName(t)[0], d = /^http:/.test(e.location) ? "http:" : "https:"; if (/^\/{2}/.test(s) && (s = d + s), window[i] && window[i].initialized) window[i].process && window[i].process(); else if (!e.getElementById(n)) { var a = e.createElement(t); a.async = 1, a.id = n, a.src = s, o.parentNode.insertBefore(a, o) } }(document, "script", "infogram-async", "https://e.infogram.com/js/dist/embed-loader-min.js");
            // }
            initSiema(parseInt(element.properties.id));
            card.classList.remove("card--hidden");

            document.querySelector('.card-footer').classList.add("show");
            document.querySelector('.card-footer').classList.remove("hide");

        }

        var siemaDiv = document.querySelector(".siema");

        function destroySiema() {
            if (typeof(mySiema)) {
                mySiema.destroy(false, () => {
                while (siemaDiv.firstChild) {
                    siemaDiv.removeChild(siemaDiv.firstChild);
                }
                console.log('Destroy it bro 💣 💣 💣');
            })
            }
        }

        function initSiema(id) {
            var imgs = pgContents.find(function (element) {
                return element.id == id;
            });

            imgs.images.forEach(image => {
                console.log(image);
                var img = document.createElement("img");
                img.setAttribute("src", "images/playgrounds/" + image.src);
                img.setAttribute("alt", image.alt);
                siemaDiv.appendChild(img);
                siemaDiv.append(img);
            })
            mySiema = new Siema({
                loop: true,
                onInit: printSlideIndex,
                onChange: printSlideIndex
            });
        }


        function printSlideIndex() {
            var imgs = pgContents.find(function (element) {
                return element.id == currentID;
            });
            let imageTotal = imgs.images.length;
            var caption = document.querySelector('.caption');
            caption.textContent = imgs.images[parseInt(this.currentSlide % imageTotal)].alt
            var credit = document.createElement("span");
            credit.className = 'credit';
            credit.textContent = imgs.images[parseInt(this.currentSlide % imageTotal)].credit;
            caption.appendChild(credit);

            var stateObj = { playground_id: currentID };
                    window.history.pushState(stateObj, "", `#${entrySource}&id=${currentID}&img=${this.currentSlide}`);
        }

        function onMapClick(e) {
            pgmap.fitBounds([[22.271194, 114.178092], [22.286079, 114.192911]], { padding: [50, 50] });
        }

        var serachMarkers = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "bound": [[22.271194, 114.178092], [22.286079, 114.192911]],
                        "icon": "searchMkr1",
                        "marker-size": "medium",
                        "marker-symbol": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            114.180181,
                            22.262056
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "bound": [[22.302329, 114.172774], [22.310514, 114.179198]],
                        "icon": "searchMkr1",
                        "marker-size": "medium",
                        "marker-symbol": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            114.175392,
                            22.312573,
                        ]
                    }
                }
            ]
        }

        var searchMkr1 = L.icon({
            iconUrl: 'images/searchMarker.png',
            iconSize: [48, 48],
            iconAnchor: [24, 24]
        });


        var searchMkr_layer = new L.FeatureGroup();

        L.geoJSON(serachMarkers, {
            pointToLayer: function (geoJsonPoint, latlng) {
                return L.marker(latlng, { icon: searchMkr1 })
            },
            onEachFeature: searchZoom
        }).addTo(searchMkr_layer);

        pgmap.addLayer(searchMkr_layer);

        function searchZoom(feature, layer) {
            layer.on('click', function (e) {
                pgmap.fitBounds(feature.properties.bound, { padding: [50, 50] });
            })
        }

        pgmap.on('zoomend', function () {
            if (pgmap.getZoom() < 13) {
                pgmap.addLayer(searchMkr_layer);
            }
            else {
                pgmap.removeLayer(searchMkr_layer);
            }
        });


        const numberWithCommas = (x) => {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }



    </script>

</body>

</html>