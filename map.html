<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>私人遊樂場地契約用地地圖</title>
    <meta name="author" content="香港01">
    <meta name="description" content="車主福音！一圖睇清全港各區泊車位！香港開放數據落後，我地為你搜集咗全港停車場位置，除咗室內停車場，仲有露天停車場同咪錶位！">
    <meta name="publisher" content="HK01">

    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
        crossorigin="" />
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js" integrity="sha512-tAGcCfR4Sc5ZP5ZoVz0quoZDYX5aCtEm/eu1KhSLj2c9eFrylXZknQYmxUssFaVJKvvc0dJQixhGjG2yXWiV9Q=="
        crossorigin=""></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU"
        crossorigin="anonymous">


    <link rel="stylesheet" href="src/custom.css">
    <script src="src/playgrounds.js"></script>
    <script src="src/pgContents.js"></script>
    <script src="src/siema.min.js"></script>
</head>

<body>

    <div id='mapid'></div>
    <div class="card card--custom card--hidden">
        <div class="card-header">
            <span id="cardType"></span>
            <button type="button" class="close" id="close-card" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <button type="button" class="close" id="nextBtn" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">＞</span>
            </button>
            <button type="button" class="close" id="prevBtn" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">＜</span>
            </button>
        </div>
        <div class="card-body">
            <span class="card-title" id="cardName"></span>

            <div id="siema_container">
                <div class="siema_control">
                    <button id="prev">prev</button>
                    <button id="next">next</button>
                </div>
                <div class="siema">
                    <img>
                    <img>
                    <img>
                </div>
                <p class="caption"></p>&nbsp;<span class="credit"></span>
            </div>
            
            <div class="container">
                <ul class="fa-ul" id="cardDetail"></ul>
                <p class="remarks"></p>
            </div>
        </div>
    </div>


    <script>
        var pgmap;
        var entrySource;
        var currentID;
        const mySiema = new Siema({
                selector: '.siema',
                duration: 200,
                easing: 'ease-out',
                perPage: 1,
                startIndex: 0,
                draggable: true,
                multipleDrag: true,
                threshold: 20,
                loop: true,
                rtl: false,
                onInit: printSlideIndex,
                onChange: printSlideIndex,
            });

        var shape_blue = {
            'color': '#0017c7',
            'weight': 2,
            'fillColor': '#0017c7',
            'fillOpacity': 0.5
        };

        var shape_red = {
            'color': '#F21326',
            'weight': 2,
            'fillColor': '#F21326',
            'fillOpacity': 0.5
        };

        function detectSource(callback) {
            let linkText = window.location.href;
            entrySource = (linkText.match(/#/)) ? linkText.match(/#(.*?)(&|$)/)[1] : "organic";
            currentID = (linkText.match(/&id=/)) ? linkText.match(/&id=(\d+)/)[1] : 0;
            var entryPoint = "";


            switch (entrySource) {
                case "article":
                    var prevent_double_count = 1;
                    entryPoint = "other_article";
                    // m6map.once('movestart', function () {
                    //     fireArticlePV(removehash(window.location.href));
                    // })
                    break;
                case "self":
                    entryPoint = "base_article";
                    break;
                case "issue":
                    entryPoint = "issue";
                    // fireArticlePV(removehash(window.location.href));
                    break;
                case "freeze":
                    entryPoint = "freeze";
                    break
                default:
                    // window.location.href = "https://www.hk01.com";
                    entryPoint = "organic";
                // fireArticlePV(removehash(window.location.href));
            }
            callback(entryPoint, currentID);
        }


        detectSource(initMap);

        function initMap(entryPoint, currentID) {

            console.log(entryPoint + " | " + currentID);

            var map_options = {
                center: (screen.width >= 768) ? [22.372809, 114.120322] : [22.372809, 114.1660907],
                zoom: 11, //(screen.width >= 768) ? 11 : 11,
                zoomSnap: 0,
                zoomDelta: 1,
                wheelPxPerZoomLevel: 20,
                maxBounds: ([
                    [21.795661, 113.073929],
                    [23.113786, 115.230749]
                ]),
                keyboard: false // Prevent jumping in iframe
            }

            pgmap = L.map('mapid', map_options);

            L.tileLayer('https://maptile.hk01.com/tile/{z}/{x}/{y}.png', {
                maxZoom: 18,
                minZoom: 10,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(pgmap);

            playground_layer = L.geoJSON(playgrounds, {
                onEachFeature: popByClick,
                style: shape_blue,
            }).addTo(pgmap);

            var overlayMaps = {
                "用地": playground_layer
            };

            //     L.control.layers({}, overlayMaps, {
            //         collapsed: false,
            //         position: 'topright'
            //     }).addTo(pgmap);
        }



        var card = document.querySelector('.card--custom');
        var card_header = document.querySelector('.card-header');

        card.addEventListener('click', (event) => {
            card.classList.toggle('card--expanded');
            event.stopPropagation();
        });

        var closeCard = document.querySelector('#close-card');
        closeCard.addEventListener('click', (event) => {
            card.classList.add("card--hidden");
            card.classList.remove('card--expanded');
            event.stopPropagation();
        });

        var nextBtn = document.getElementById('nextBtn');
        nextBtn.addEventListener('click', function (event) {
            event.preventDefault();
            if (currentID < 32) popByID(currentID + 1);
            else popByID(1);
            event.stopPropagation();
        })

        var prevBtn = document.getElementById('prevBtn');
        prevBtn.addEventListener('click', function (event) {
            event.preventDefault();
            if (currentID > 1) popByID(currentID - 1);
            else popByID(32);
            event.stopPropagation();
        })


        function popByClick(feature, layer) {
            feature.properties.bounds_calculated = layer.getBounds();
            layer.on('click', function (e) {
                changeState(e);
                createPopup(e);
                zoomToPolygon(e);
            })
        }

        function popByID(id) {
            playgrounds.find(function (element) {
                if (parseInt(element.properties.id) == id) {
                    changeState(id);
                    createPopup(element);
                    zoomToPolygon(L.geoJson(element));
                }
            });
        }

        function changeState(e) {
            if (e.type) {
                // e.target.setStyle(shape_red);
                currentID = parseInt(e.target.feature.properties.id);
            }
            else {
                //e.target.setStyle(shape_red);
                currentID = e;
            }

            // Change URL onClick
            var stateObj = { playground_id: currentID };
            window.history.pushState(stateObj, "", `#${entrySource}&id=${currentID}`);
        }

        function zoomToPolygon(e) {
            if (e.target) bbox = e.target.getBounds();
            else bbox = e.getBounds();
            // console.log(e);
            // console.log(e.target.feature.properties.bounds_calculated);
            // console.log(bbox.toBBoxString());
            // console.log(bbox.getSouth());
            tuned_bbox = bbox;
            switch (parseInt(currentID)) {
                case 2:
                    tuned_bbox = L.latLngBounds([22.278790, 114.190460], [22.280482, 114.192329]);
                    break;
                case 10:
                    tuned_bbox = L.latLngBounds([22.273413, 114.180323], [22.275704, 114.183000]);
                    break;
                case 17:
                    tuned_bbox = L.latLngBounds([22.267781, 114.190859], [22.269909, 114.193376]);
                    break;
            }
            // console.log(tuned_bbox)
            tuned_bbox._southWest.lat = bbox.getSouth() - (bbox.getNorth() - bbox.getSouth()) * 2.5;
            //tuned_bbox.extend([bbox.getSouth() - (bbox.getNorth() - bbox.getSouth()) * 2.5, bbox.getEast()]);
            console.log('extned');
            console.log(tuned_bbox.getSouth());
            console.log(bbox.getSouth());
            pgmap.fitBounds(tuned_bbox, { padding: [50, 50] });

        }




        function createPopup(e) {
            var prop;

            if (e.type != "Feature") prop = e.target.feature.properties;
            else prop = e.properties;

            document.getElementById("cardType").textContent = prop["type"];
            document.getElementById("cardType").className = (prop["type"] == "港島") ? "blue" : (prop["type"] == "九龍") ? "red" : "green";

            document.getElementById("cardName").innerHTML = prop["chi_name"];
            var content = `
                    <li><span class="fa-li"><i class="fas fa-expand-arrows-alt fa-fw"></i></span>面積：${(prop["area"] > 9999) ? numberWithCommas(Math.round(prop["area"] / 10000, 0)) + '公頃' : numberWithCommas(prop["area"]) + '呎'}</li>`

            content += `<li><span class="fa-li"><i class="fas fa-user-circle fa-fw"></i></span>會員：${numberWithCommas(prop["members"])}人</li>`;

            if (prop["avg_usage"]) content += `<li><span class="fa-li"><i class="fas fa-golf-ball fa-fw"></i></span>體育設施平均使用率：${prop["avg_usage"]}</li>`
            if (prop["comm_revenue"] > 0) content += `<li><span class="fa-li"><i class="fas fa-hand-holding-usd fa-fw"></i></span>最新年度的商業收入佔比：${prop["comm_revenue_percent"]}</li>`

                +
                `<li><span class="fa-li"><i class="fas fa-calendar-times fa-fw"></i></span>契約到期：${prop["due_date"]}</li>         
            `

            document.getElementById("cardDetail").innerHTML = content;
            document.querySelector(".remarks").innerHTML = prop["remarks"];

            card.classList.remove("card--hidden");

            console.log(prop["id"]);
            initSiema();
        }

        function initSiema() {
            var siemaDiv = document.querySelector(".siema");
            // while (siemaDiv.childNodes) {
                mySiema.remove(0);

while (siemaDiv.firstChild) {
    mySiema.remove(0);
    siemaDiv.removeChild(siemaDiv.firstChild);
}     


            // mySiema.destroy(true, () => {
                var imgs = pgContents.find(function (element) {
                    return element.id == 12;
                });
                console.log(imgs);
                var siemaDiv = document.querySelector(".siema");

                imgs.images.forEach(image => {
                    console.log(image);
                    var img = document.createElement("img");
                    img.setAttribute("src", "images/playgrounds/" + image.src);
                    img.setAttribute("alt", image.alt);
                    siemaDiv.appendChild(img);
                    mySiema.append(img);
                })

            // });
            

            
            document.getElementById('prev').addEventListener('click', (e) => {
                mySiema.prev();
                e.stopPropagation();
            });
            document.getElementById('next').addEventListener('click', (e) => {
                mySiema.next();
                e.stopPropagation();
            });
        }



        function printSlideIndex() {
            let imageTotal = pgContents[0].images.length;
            var caption = document.querySelector('.caption');
            caption.textContent = pgContents[0].images[parseInt(this.currentSlide % imageTotal)].alt
            var credit = document.createElement("span");
            credit.className = 'credit';
            credit.textContent = pgContents[0].images[parseInt(this.currentSlide % imageTotal)].credit;
            caption.appendChild(credit);
        }

        function onMapClick(e) {
            pgmap.fitBounds([[22.271194, 114.178092], [22.286079, 114.192911]], { padding: [0, 0] });
        }


        pgmap.on('zoomend', function () {
            console.log(pgmap.getZoom());
        })


        var serachMarkers = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "bound": [[22.271194, 114.178092], [22.286079, 114.192911]],
                        "icon": "searchMkr1",
                        "marker-size": "medium",
                        "marker-symbol": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            114.180181,
                            22.262056
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "bound": [[22.302329, 114.172774], [22.310514, 114.179198]],
                        "icon": "searchMkr1",
                        "marker-size": "medium",
                        "marker-symbol": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            114.175392,
                            22.312573,
                        ]
                    }
                }
            ]
        }

        var searchMkr1 = L.icon({
            iconUrl: 'images/searchMarker.png',
            iconSize: [48, 48],
            iconAnchor: [24, 24]
        });


        var searchMkr_layer = new L.FeatureGroup();

        L.geoJSON(serachMarkers, {
            pointToLayer: function (geoJsonPoint, latlng) {
                return L.marker(latlng, { icon: searchMkr1 })
            },
            onEachFeature: searchZoom
        }).addTo(searchMkr_layer);

        pgmap.addLayer(searchMkr_layer);

        function searchZoom(feature, layer) {
            layer.on('click', function (e) {
                pgmap.fitBounds(feature.properties.bound, { padding: [0, 0] });
            })
        }

        pgmap.on('zoomend', function () {
            if (pgmap.getZoom() < 13) {
                pgmap.addLayer(searchMkr_layer);
            }
            else {
                pgmap.removeLayer(searchMkr_layer);
            }
        });


        const numberWithCommas = (x) => {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }



    </script>

</body>

</html>